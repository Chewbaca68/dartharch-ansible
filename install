#!/usr/bin/env bash

read -s -rp "Root Password: " root_pass; echo
read -s -rp "Confirm root password: " root_pass2; echo
[ "$root_pass" = "$root_pass2" ] || { echo "Passwords don't match"; exit 1; }

#echo "root var $root_pass root2 var $root_pass2"
#root_pass2 = "" && unset root_pass2
#echo "root var $root_pass root2 var $root_pass2"
#exit
read -rp "Username: " username
read -s -rp "Password: " password; echo
read -s -rp "Confirm password: " password2; echo
[ "$password" = "$password2" ] || { echo "Passwords don't match"; exit 1; }

hash=$(mkpasswd -m sha512crypt --stdin <<<"$password")
root_hash=$(mkpasswd -m sha512crypt --stdin <<<"$root_pass")

creds=$(jq -n --arg u "$username" --arg h "$hash" --arg rp "$root_hash" '{users:[{username:$u,enc_password:$h,sudo:true}], root_enc_password:$rp}')
printf '%s' "$creds" > /tmp/user_credentials.json
chmod 600 /tmp/user_credentials.json

cat /tmp/user_credentials.json

MAX_RETRIES=3
RETRY_COUNT=0
while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if curl -s --fail https://raw.githubusercontent.com/Chewbaca68/dartharch-ansible/main/user_configuration.json -o /tmp/user_configuration.json; then
        break
    fi
    RETRY_COUNT=$((RETRY_COUNT + 1))
    if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
        echo "Download failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
        sleep 2
    fi
done

if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    echo "ERROR: Failed to download user_configuration.json after $MAX_RETRIES attempts"
    echo "Please check your network connection and try again"
    exit 1
fi

echo "Starting archinstall..."
archinstall --config /tmp/user_configuration.json --creds /tmp/user_credentials.json

echo "Cleaning up..."
shred -u /tmp/user_credentials.json /tmp/user_configuration.json

echo "Installation complete! Reboot to start your CTF attack box."
